<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Snapshot Messages</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://kit.fontawesome.com/b3b89cf277.js" crossorigin="anonymous"></script>
</head>

<style>
    * {
        box-sizing: border-box;
    }

    .hoP {
        position: fixed;
        left: 5%;
        top: 0;
        width: 0;
        overflow: hidden;
        transition: all 0.6s linear;
        background: white;
    }

    .left {
        border-radius: 20px 20px 20px 0;
    }

    .right {
        border-radius: 20px 20px 0 20px;
    }

    .messageBox {
        width: 100%;
        height: 40px;
        display: flex;
        align-items: center;
        border: none;
        justify-content: center;
        padding: 0 15px;
        overflow: hidden;
    }

    .fileUploadWrapper {
        width: fit-content;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: Arial, Helvetica, sans-serif;
    }

    #file {
        display: none;
    }

    .fileUploadWrapper label {
        cursor: pointer;
        width: fit-content;
        height: fit-content;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .fileUploadWrapper label svg {
        height: 18px;
    }

    .fileUploadWrapper label svg path {
        transition: all 0.3s;
    }

    .fileUploadWrapper label svg circle {
        transition: all 0.3s;
    }

    .fileUploadWrapper label:hover svg path {
        stroke: #fff;
    }

    .fileUploadWrapper label:hover svg circle {
        stroke: #fff;
        fill: #000000;
    }

    #messageInput {
        height: 100%;
        background-color: transparent;
        outline: none;
        border: none;
        padding-left: 10px;
        color: white;
    }

    #messageInput:focus~#sendButton svg path,
    #messageInput:valid~#sendButton svg path {
        fill: #d0d0d0;
        stroke: white;
    }

    #sendButton {
        width: fit-content;
        height: 100%;
        background-color: transparent;
        outline: none;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    #sendButton svg {
        height: 18px;
        transition: all 0.3s;
    }

    #sendButton svg path {
        transition: all 0.3s;
    }

    #sendButton:hover svg path {
        fill: #d6d6d6;
        stroke: white;
    }

    .active {
        border: 3px solid rgb(0, 255, 0);
    }
</style>

<body class="text-black overflow-hidden">

    <div class="w-full h-screen flex bg-white">
        <nav
            class="fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-zinc-300 flex justify-around items-center py-2 md:hidden buttonBar">

            <a href="/" class="flex flex-col hover:bg-zinc-100 rounded-sm p-1 items-center text-xs">
                <svg aria-label="Home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                    <path d="M3 9.5L12 3l9 6.5"></path>
                    <path d="M5 10.5V21a1 1 0 0 0 1 1h4v-6a2 2 0 0 1 4 0v6h4a1 1 0 0 0 1-1V10.5"></path>
                </svg>
            </a>

            <button id="notif"
                class="p-2 rounded-lg text-sm hover:bg-zinc-100 rounded-sm p-1 cursor-pointer  hover:bg-zinc-100 flex gap-3 items-center">
                <i class="fa-regular fa-heart fa-xl cursor-pointer" style="color: #000000;"></i>
            </button>

            <a href="/post/post" class="flex flex-col hover:bg-zinc-100 p-1 rounded-sm items-center text-xs">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" class="w-6 h-6">
                    <rect x="3" y="3" width="18" height="18" rx="3" />
                    <path d="M12 8v8" />
                    <path d="M8 12h8" />
                </svg>
            </a>

            <a href="/message/message" class="flex flex-col bg-zinc-100 p-1 rounded-sm items-center text-xs">
                <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
            </a>

            <a href="/profile" class="flex flex-col items-center hover:bg-zinc-100 p-1 rounded-sm text-xs">
                <img src="<%= user.image_src %>" alt="" class=" size-7 rounded-[50%]" style="object-fit: cover;">
            </a>


        </nav>

        <aside class="hidden md:flex flex-col gap-4 nav2 py-4 px-3 border-r border-black bg-white buttonBar bts4">

            <div class="flex flex-row items-center gap-2 pt-5">
                <img src="https://res.cloudinary.com/ddiyrbync/image/upload/v1767356520/ChatGPT_Image_Jan_2_2026_05_50_04_PM_xpxaqz.jpg"
                    class="size-10" style="object-fit: cover;" alt="">
            </div>
            <a href="/"
                class=" border-1 border-solid border-white p-2 hover:bg-zinc-100 rounded-lg flex gap-3 items-center">
                <svg aria-label="Home" class="x1lliihq x1n2onr6 x5n08af" fill="currentColor" height="24" role="img"
                    viewBox="0 0 24 24" width="24">
                    <title>Home</title>
                    <path
                        d="m21.762 8.786-7-6.68C13.266.68 10.734.68 9.238 2.106l-7 6.681A4.017 4.017 0 0 0 1 11.68V20c0 1.654 1.346 3 3 3h5.005a1 1 0 0 0 1-1L10 15c0-1.103.897-2 2-2 1.09 0 1.98.877 2 1.962L13.999 22a1 1 0 0 0 1 1H20c1.654 0 3-1.346 3-3v-8.32a4.021 4.021 0 0 0-1.238-2.894ZM21 20a1 1 0 0 1-1 1h-4.001L16 15c0-2.206-1.794-4-4-4s-4 1.794-4 4l.005 6H4a1 1 0 0 1-1-1v-8.32c0-.543.226-1.07.62-1.447l7-6.68c.747-.714 2.013-.714 2.76 0l7 6.68c.394.376.62.904.62 1.448V20Z">
                    </path>
                </svg>
            </a>
            <a href="/profile"
                class=" border-1 border-solid border-white p-2 rounded-xl hover:bg-zinc-100 flex gap-3 items-center">
                <img src="<%= user.image_src %>" alt="" class=" size-7 rounded-[50%] object-cover"></a>

            <a href="/post/post" class="p-2 rounded-lg hover:bg-zinc-100 flex gap-3 items-center">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" class="w-6 h-6">
                    <rect x="3" y="3" width="18" height="18" rx="3" />
                    <path d="M12 8v8" />
                    <path d="M8 12h8" />
                </svg>
            </a>

            <a href="/message/message" class="p-2 rounded-lg  bg-zinc-100  hover:bg-zinc-100 flex gap-3 items-center">
                <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
            </a>

            <button id="notif" class="p-2 rounded-lg text-sm cursor-pointer  hover:bg-zinc-100 flex gap-3 items-center">
                <i class="fa-regular fa-heart fa-xl cursor-pointer" style="color: #000000;"></i>
                <span class="overflow-hidden w-0 text-white">Notification</span>
            </button>

            <a href="/logout" class="p-2 rounded-lg hover:bg-zinc-100 flex gap-3 items-center mt-auto">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" class="w-6 h-6">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                    <path d="M16 17l5-5-5-5" />
                    <path d="M21 12H9" />
                </svg>
            </a>

        </aside>

        <div class="w-full mainUSE md:w-[30%] border-r border-[#f3f3f3] flex flex-col bg-white">

            <div class="flex justify-between items-center px-5 py-4 text-lg font-bold text-black">
                <%= user.Username %>
            </div>

            <div class="px-4">
                <input class="w-full px-4 py-2 rounded-full bg-gray-100 border border-[#f3f3f3] outline-none text-black"
                    placeholder="Search">
            </div>

            <div class="p-4 flex gap-3 items-center">
                <img src="<%= user.image_src %>" class="size-12 rounded-full object-cover" alt="">

                <div>
                    <p class="text-gray-500 text-sm">Your note</p>
                </div>
            </div>

            <div class="px-4 flex justify-between text-sm text-gray-600">
                <p>Messages</p>
                <p>Requests</p>
            </div>

            <div id="userList" class="mt-4 flex-1 overflow-y-auto"></div>
        </div>

        <div class="flex-1 mainMOB hidden md:flex flex-col bg-white">
            <div id="chatTop" class="hidden p-4 border-b border-[#f3f3f3] justify-between items-center bg-white">
                <div class="flex items-center gap-3">
                    <i class="fa-solid backaro fa-arrow-left-long fa-2xl" style="color: #000000;"></i>
                    <img id="topImg" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <h2 id="topName" class="font-semibold text-black"></h2>
                        <p id="topUser" class="text-gray-500 text-sm"></p>
                        <input type="hidden" value="" id="toId">
                    </div>
                </div>
            </div>

            <div id="welcome" class=" flex flex-col justify-center items-center h-full text-center">
                <div class="overflow-hidden h-20 w-20">
                    <img class="w-full h-full rounded-full mb-4 bg-[#f3f3f3]"
                        src="https://res.cloudinary.com/ddiyrbync/image/upload/v1767356520/ChatGPT_Image_Jan_2_2026_05_50_04_PM_xpxaqz.jpg" />
                </div>
                <h1 class="text-2xl font-bold text-black">Snapshot</h1>
                <p class="text-gray-500">Select a conversation to start chatting</p>
            </div>

            <div id="chatBox" class="hidden flex flex-col h-[76vh] bg-white px-2">

                <div id="messages" class="h-full overflow-y-auto space-y-3 px-2"></div>

                <div class="flex flex-col border border-zinc-400 rounded-lg w-full items-center justify-center">

                    <div class="flex flex-wrap gap-2 h-[fit-content] showww w-[99%] keyss"></div>

                    <div class="messageBox flex gap-1 px-2 items-end w-full">

                        <div class="fileUploadWrapper keyss">
                            <label for="file">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 337 337">
                                    <circle stroke-width="20" stroke="#6c6c6c" fill="none" r="158.5" cy="168.5"
                                        cx="168.5"></circle>
                                    <path stroke-linecap="round" stroke-width="25" stroke="#6c6c6c" d="M167.759 79V259">
                                    </path>
                                    <path stroke-linecap="round" stroke-width="25" stroke="#6c6c6c" d="M79 167.138H259">
                                    </path>
                                </svg>
                            </label>
                            <input type="file" id="file" name="file" multiple
                                accept="image/*,audio/*,.pdf,.doc,.docx" />
                        </div>

                        <input id="msgInput" class="keyss outline-none border-none w-full" placeholder="Message..."
                            type="text" />

                        <button id="sendButton" onclick="sendMessage()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 664 663">
                                <path stroke-linejoin="round" stroke-linecap="round" stroke-width="33.67"
                                    stroke="#6c6c6c"
                                    d="M646.293 331.888L17.7538 17.6187L155.245 331.888M646.293 331.888L17.753 646.157L155.245 331.888M646.293 331.888L318.735 330.228L155.245 331.888">
                                </path>
                            </svg>
                        </button>

                    </div>
                </div>
            </div>

        </div>

        <input type="hidden" value="<%= Id %>" id="current">
    </div>

    <div
        class="hoP flex flex-col gap-3 rounded-r-xl mainq sm:items-center hidden items-center border-l-1 border-zinc-400 w-0 text-1xl h-[97.5vh] p-4">
        <p class="w-[100%] text-2xl text-bold">Notifications</p>
        <div
            class="overflow-y-scroll addnot w-[100%] overflow-x-hidden h-[100%] scrollbar-hide-inline [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]">
            <% if (requestUser.length> 0) {%>
                <div class="flex flex-col gap-5 mb-4">
                    <% requestUser.forEach(request=> {%>
                        <div class="w-[100%] flex flex-row items-center items-justify-between gap-5">
                            <div class="w-[50px] h-[-webkit-fill-available] rounded-[50%] overflow-hidden">
                                <p class="size-10"><img src="<%= request.image_src %>"
                                        class="rounded-[50%] border-1 border-gray-400 border-solid"
                                        style="width: 100%; height: 100%; object-fit: cover;" alt="">
                                </p>
                            </div>
                            <span class="flex flex-col text-sm w-[50%]">
                                <p>
                                    <%=request.Username %>
                                </p>
                                <p class="text-zinc-600">
                                    <%=request.First_name %>
                                </p>
                            </span>
                            <div class="flex flex-row gap-2 bt3">
                                <button
                                    class="confirm px-2 py-1 border-1 border-black border-solid rounded-2xl text-xs text-sky-500 hover:text-sky-700 cursor-pointer">Confirm
                                    <input type="hidden" name="" value="<%=request.Id %>" id=""></button>
                                <button
                                    class="decline px-2 py-1 border-1 border-black border-solid rounded-2xl text-xs text-sky-500 hover:text-sky-700 cursor-pointer">Decline
                                    <input type="hidden" name="" value="<%=request.Id %>" id=""></button>
                            </div>
                        </div>
                        <% }); %>
                </div>
                <% } else{%>
                    <div class="_aajq flex flex-col pb-3 justify-center items-center w-[100%] text-center">
                        <div class="_aajr"><svg aria-label="Activity On Your Posts" class="x1lliihq x1n2onr6 x5n08af"
                                fill="currentColor" height="62" role="img" viewBox="0 0 96 96" width="62">
                                <title>Activity On Your Posts</title>
                                <circle cx="48" cy="48" fill="none" r="47" stroke="currentColor" stroke-linecap="round"
                                    stroke-linejoin="round" stroke-width="2">
                                </circle>
                                <path
                                    d="M48 34.4A13.185 13.185 0 0 0 37.473 29a12.717 12.717 0 0 0-6.72 1.939c-6.46 3.995-8.669 12.844-4.942 19.766 3.037 5.642 16.115 15.6 20.813 19.07a2.312 2.312 0 0 0 2.75 0c4.7-3.47 17.778-13.428 20.815-19.07 3.728-6.922 1.517-15.771-4.943-19.766A12.704 12.704 0 0 0 58.527 29 13.193 13.193 0 0 0 48 34.4Z"
                                    fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2"></path>
                            </svg></div>
                        <h2 class="_aajt"><span
                                class="x1lliihq x1plvlek xryxfnj x1n2onr6 xyejjpt x15dsfln x193iq5w xeuugli x1fj9vlw x13faqbe x1vvkbs x1s928wv xhkezso x1gmr53x x1cpjm7i x1fgarty x1943h6x x1i0vuye xvs91rp xo1l8bm x5n08af x10wh9bi xpm28yp x8viiok x1o7cslx"
                                dir="auto"
                                style="--x---base-line-clamp-line-height: 18px; --x-lineHeight: 18px;">Activity
                                On Your Posts</span></h2>
                        <h3 class="_aaju"><span
                                class="x1lliihq x1plvlek xryxfnj x1n2onr6 xyejjpt x15dsfln x193iq5w xeuugli x1fj9vlw x13faqbe x1vvkbs x1s928wv xhkezso x1gmr53x x1cpjm7i x1fgarty x1943h6x x1i0vuye xvs91rp xo1l8bm x5n08af x10wh9bi xpm28yp x8viiok x1o7cslx"
                                dir="auto" style="--x---base-line-clamp-line-height: 18px; --x-lineHeight: 18px;">When
                                someone likes or comments on one of your posts, you'll see it here.</span>
                        </h3>
                    </div>
                    <% } %>

                        <p class="py-2 w-full">Suggsion for you</p>
                        <div class="flex flex-col gap-5">
                            <% if (suggsionId) {%>
                                <% suggsionId.forEach(request=> {%>
                                    <div class="w-[100%] flex flex-row items-center items-justify-between gap-5">
                                        <button class="cursor-pointer userOther flex gap-3 flex-row w-[80%] text-left">
                                            <p class="size-10"><img src="<%= request.image_src %>"
                                                    class="rounded-[50%] border-1 border-gray-400 border-solid"
                                                    style="width: 100%; height: 100%; object-fit: cover;" alt="">
                                            </p>
                                            <input type="hidden" name="username" value="<%= request.Username %>" id="">
                                            <input type="hidden" name="Id" value="<%= request.Id %>" id="">
                                            <span class="flex flex-col gap-1">
                                                <p class="text-sm">
                                                    <%= request.Username %>
                                                </p>
                                                <p class="text-zinc-600 text-xs">
                                                    <%=request.First_name %>
                                                </p>
                                            </span>
                                        </button>

                                        <div class="flex flex-row gap-2 ">
                                            <button
                                                class="p-1 px-10 bg-sky-500 hover:bg-sky-700 cursor-pointer rounded-lg text-white text-sm follow">Follow
                                                <input type="hidden" value="<%= request.Id %>">
                                                <input type="hidden" value="<%= request.Username %>">
                                                <input type="hidden" value="<%= request.First_name %>">
                                                <input type="hidden" value="<%= request.image_src %>">
                                            </button>
                                        </div>
                                    </div>
                                    <% }); %>
                                        <% } %>
                        </div>

        </div>
    </div>

    <script src="/js/script.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let activeUser = null;
        let conversation = []
        const Id = document.getElementById("toId");
        const current = document.getElementById("current");
        const box = document.getElementById("messages");
        const input = document.getElementById("msgInput");
        const userList = document.getElementById("userList");
        const mainMOB = document.querySelector(".mainMOB");
        const mainUSE = document.querySelector(".mainUSE");
        const backaro = document.querySelector(".backaro");
        const showww = document.querySelector(".showww");
        const fileInput = document.getElementById("file");
        const msgInput = document.getElementById("msgInput");
        const keyss = document.querySelectorAll(".keyss");

        let filesToSend = [];

        fileInput.addEventListener("change", function () {
            [...this.files].forEach(file => {
                filesToSend.push(file);
                showPreview(file);
            });
            this.value = "";
        });

        function showPreview(file) {
            const wrapper = document.createElement("div");
            wrapper.className =
                "relative w-16 h-16 rounded-lg overflow-hidden border bg-gray-100 m-1";

            const loading = document.createElement("div");
            loading.className =
                "absolute inset-0 bg-black/30 flex items-center justify-center hidden loddd";
            loading.innerHTML = `
                <div class="w-4 h-4 border-2 border-white border-t-transparent
                    rounded-full animate-spin"></div>`;

            const remove = document.createElement("button");
            remove.innerHTML = "âœ•";
            remove.className =
                "absolute top-1 right-1 bg-black/70 text-white cursor-pointer ccc text-xs w-5 h-5 rounded-full flex items-center justify-center";
            remove.onclick = () => {
                filesToSend = filesToSend.filter(f => f !== file);
                wrapper.remove();
            };

            if (file.type.startsWith("image/")) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "w-full h-full object-cover";
                wrapper.appendChild(img);
            }
            else if (file.type.startsWith("audio/")) {
                wrapper.classList.add("flex", "items-center", "justify-center");
                wrapper.innerHTML = `<i class="fa-solid fa-music text-xl text-gray-600"></i>`;
            }
            else {
                wrapper.classList.add("flex", "items-center", "justify-center");
                wrapper.innerHTML = `<i class="fa-solid fa-file text-xl text-gray-600"></i>`;
            }

            wrapper.appendChild(loading);
            wrapper.appendChild(remove);
            showww.appendChild(wrapper);
        }

        let socket;
        if (window.innerWidth > 500) {
            backaro.style.display = 'none'
        }

        function ago(t) {
            const diffMs = Date.now() - new Date(t);
            const s = Math.floor(diffMs / 1000);
            const m = Math.floor(s / 60);
            const h = Math.floor(m / 60);
            const d = Math.floor(h / 24);
            if (s < 60) return `Just Now`;
            if (m < 60) return `${m} min ago`;
            if (h < 24) return `${h} hr ago`;
            return `${d} day ago`;
        }

        function appendIncomingMessage(data) {
            let filesHTML = "";
            let cope = null

            if (Array.isArray(data.files)) {
                data.files.forEach(file => {
                    cope = file.url
                    if (file.type === "image") {
                        filesHTML += `
                    <img src="${file.url}"
                         class="mt-2 left max-w-[220px]" />
                `;
                    }
                    else if (file.type === "audio") {
                        filesHTML += `
                    <audio controls class="mt-2 left w-[220px]">
                        <source src="${file.url}">
                    </audio>
                `;
                    }
                    else {
                        filesHTML += `
                    <a href="${file.url}" target="_blank"
                       class="block mt-2 text-blue-600 underline">
                        ðŸ“„ ${file.name || "Download file"}
                    </a>
                `;
                    }
                });
            }

            const div = document.createElement("div");
            div.className = "text-left";

            div.innerHTML = `
    <div class="group relative inline-block max-w-[70%]">

      ${filesHTML ? `${filesHTML}` : ""}
      <button class="absolute -top-2 cursor-pointer -right-2 w-7 h-7 rounded-full bg-white shadow-md text-gray-500 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-all duration-150" onclick="toggleMenu(this)">â‹®</button>

      <div class="menu absolute right-10 top-3 z-50 bg-white rounded-xl shadow-xl text-sm  min-w-[150px] overflow-hidden  opacity-0 invisible scale-95  transition-all duration-107">
        <button class="absolute -top-2 cursor-pointer -left-2 w-7 h-7 rounded-full bg-white shadow-md text-gray-500 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-all duration-150" onclick="toggleMenu(this)">â‹®</button>
        <div class="menu absolute left-10 top-3 z-50 bg-white rounded-xl shadow-xl text-sm  min-w-[150px] overflow-hidden  opacity-0 invisible scale-95  transition-all duration-107">
        <button onclick="copyMessage('${data.message ? `${data.message}` : `${cope}`}')" class="w-full text-left px-4 py-2 hover:bg-gray-100"> ðŸ“‹ Copy</button>
        <p class="msg-time text-gray-500 text-xs mt-1 text-center" data-time="${data.created_at}">${ago(data.created_at)}</p></div>

        ${data.message ? `<span class="px-3 py-2 inline-block rounded-2xl break-words bg-[#f3f3f3] text-black left"> ${data.message}</span>` : ""}
    
        <p class="msg-time text-gray-500 text-xs mt-1" data-time="${m.created_at}">${Msago(m.created_at)}</p> 
    </div>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function lastMessagePreview(mess) {
            if (mess.lastMessage) return mess.lastMessage;

            if (!Array.isArray(mess.file) || mess.file.length === 0) return "";

            const type = mess.file[0].type;
            if (type === "image") return "ðŸ“· Photo";
            if (type === "audio") return "ðŸŽµ Audio";
            return "ðŸ“„ Document";
        }

        function usrList() {
            userList.innerHTML = "";

            const sortedConversation = [...conversation].sort((a, b) => {
                if (a.isActive === b.isActive) {
                    return new Date(b.created_at) - new Date(a.created_at);
                }
                return b.isActive - a.isActive;
            });

            sortedConversation.forEach(mess => {
                const div = document.createElement("div");

                div.className = "flex items-center justify-between gap-3 px-4 py-3 hover:bg-gray-200 cursor-pointer";

                div.addEventListener("click", () => { openChat(`${mess.Id}`, `${mess.First_name}`, `${mess.Username}`, `${mess.image_src}`); });

                div.innerHTML = `
            <div class="flex gap-3 items-center">
                <div class="relative">
                    <img src="${mess.image_src}" class="w-12 h-12 rounded-full object-cover">
                    ${mess.isActive ? ` <span class="absolute bottom-0 right-0 h-3 w-3 rounded-full bg-green-500 shadow-[0_0_6px_rgba(34,197,94,0.8)]"></span>` : ''}
                </div>

                <div class="flex flex-col">
                    <p class="font-semibold text-black">${mess.Username}</p>
                    <p class="text-gray-600 text-sm truncate max-w-[160px]">
                        ${lastMessagePreview(mess)}
                    </p>
                </div>
            </div>

            <div class="flex flex-col items-end text-xs text-zinc-500">
                <span class="msg-time" data-time="${mess.created_at}">
                      ${ago(mess.created_at)}
                </span>
            </div>`;

                userList.appendChild(div);
            });
        }

        function openChat(id, name, username, img) {
            if (window.innerWidth < 500) {
                mainMOB.classList.remove('hidden')
                mainUSE.classList.add('hidden')
            }
            showMessage(id);
            activeUser = name;

            document.getElementById("welcome").classList.add("hidden");
            document.getElementById("chatBox").classList.remove("hidden");
            document.getElementById("chatTop").classList.remove("hidden");

            document.getElementById("topUser").innerText = name;
            document.getElementById("topName").innerText = username;
            Id.value = id;
            document.getElementById("topImg").src = img;
        }

        backaro.addEventListener('click', () => {
            mainMOB.classList.add('hidden')
            mainUSE.classList.remove('hidden')
        })

        async function sendMessage() {
            if (!input.value.trim() && filesToSend.length === 0) return;

            const messageText = input.value || '';
            input.value = "";

            let cc = document.querySelectorAll('.ccc')
            let loddd = document.querySelectorAll('.loddd')
            cc.forEach(c => c.remove());
            loddd.forEach(c => c.classList.remove('hidden'));

            const formData = new FormData();
            formData.append("message", messageText);
            formData.append("reciverId", Id.value);
            console.log(filesToSend);

            filesToSend.forEach(file => {
                formData.append("files", file);
            });
            filesToSend = [];

            const response = await fetch("/message/saveMessage", {
                method: "POST",
                body: formData
            });

            const result = await response.json();
            if (!result.success) throw new Error("Upload failed");

            renderOwnMessage(result.data);
            showww.innerHTML = "";
            socket.emit("sendMessage", {
                to: Id.value,
                message: result.data.message || '',
                files: result.data.files || '',
                created_at: result.data.created_at,
                senderId: result.data.senderId
            });

            updateUsers();
        }

        function Msago(t) {
            const date = new Date(t);
            const diffMs = Date.now() - date;
            const s = Math.floor(diffMs / 1000);
            const m = Math.floor(s / 60);
            const h = Math.floor(m / 60);
            const d = Math.floor(h / 24);

            if (s < 7) return "Just now";
            if (s < 60) return `${s} sec ago`;
            if (m < 60) return `${m} min ago`;
            if (h < 24) return date.toLocaleString(undefined, {
                hour: "numeric",
                minute: "2-digit",
                hour12: true
            });
            if (d === 1) return "Yesterday";

            return date.toLocaleString(undefined, {
                year: "numeric",
                month: "short",
                day: "numeric",
            });
        }

        function normalizeFiles(files) {
            if (!files) return [];

            if (Array.isArray(files)) return files;

            if (typeof files === "string") {
                try {
                    return JSON.parse(files);
                } catch {
                    return [];
                }
            }

            return [];
        }

        async function unsendMessage(id) {

            const res = await fetch(`/message/unSend?messid=${id}`, {
                method: "DELETE",
            });

            const result = await res.json();

            if (result.success) {
                const messageEl = document.querySelector(`[data-id="${id}"]`);
                if (messageEl) {
                    messageEl.style.transition = "opacity 0.3s";
                    messageEl.style.opacity = "0";
                    setTimeout(() => messageEl.remove(), 300);
                }
            }
        }

        function toggleMenu(btn) {
            const menu = btn.parentElement.querySelector(".menu");
            if (!menu) return;

            document.querySelectorAll(".menu").forEach(m => {
                if (m !== menu && !m.classList.contains("invisible")) {
                    m.classList.add("opacity-0", "invisible", "scale-95");
                }
            });

            menu.classList.toggle("opacity-0");
            menu.classList.toggle("invisible");
            menu.classList.toggle("scale-95");
        }

        function copyMessage(el, text) {
            navigator.clipboard.writeText(text);
            el.textContent = 'âœ“ Copied';
            setTimeout(() => {
                el.textContent = 'ðŸ“‹ Copy';
            }, 1000 * 7);
        }

        async function showMessage(id) {
            box.innerHTML = ''

            let response = await fetch(`/message/showMessage?Id=${id}`, {
                method: "POST"
            });

            let result = await response.json();

            if (!result.success) return;
            let cope = null

            box.innerHTML = "";
            result.data.forEach(m => {

                const isMe = Number(current.value) === m.senderId;
                const files = normalizeFiles(m.url);

                let filesHTML = "";
                if (files.length > 0) {
                    files.forEach(file => {
                        cope = file.url

                        if (file.type === "image") {
                            filesHTML += `<img src="${file.url}" class="mt-2 ${isMe ? "right" : "left"} max-w-[220px]" />`;
                        }
                        else if (file.type === "audio") {
                            filesHTML += `<audio controls class="bg-[#f3f3f3] max-w-[220px] ${isMe ? "right" : "left"}"><source src="${file.url}"></audio>`;
                        }
                        else {
                            const downloadUrl = file.url
                                .replace("/image/upload/", "/raw/upload/")
                                .replace("/raw/upload/", "/raw/upload/fl_attachment/");

                            filesHTML += `<a href="${downloadUrl}" download="${file.name}" class="block mt-2 text-blue-600 underline">ðŸ“„ Download ${file.name}</a>`;
                        }
                    });
                }
                let div = document.createElement("div");
                div.className = `${isMe ? "text-right" : "text-left"} message`;
                div.dataset.id = m.Id;

                const time = new Date(m.created_at).toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                });

                div.innerHTML = `
                <div class="group relative inline-block max-w-[70%]">

                  ${filesHTML ? `${filesHTML}` : ""}

                  <div class="absolute -bottom-2 w-30 cursor-pointer ${isMe ? "-left-30" : "-right-30"} overflow-hidden rounded-xl flex flex-col bg-white shadow-md text-gray-500 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-all duration-150">
                        ${isMe ? `<button onclick="unsendMessage(${m.Id})"class="w-full text-left px-4 py-2 text-red-500 hover:bg-gray-100">ðŸ—‘ Unsend </button>` : ""}     
                        <button onclick="copyMessage(this,'${m.message ? `${m.message}` : `${cope}`}')" class="w-full text-left px-4 py-2 hover:bg-gray-100">ðŸ“‹ Copy</button>
                        <p class="msg-time text-gray-500 text-xs mt-1 text-center" data-time="${m.created_at}">${ago(m.created_at)}</p>
                   </div>

                    ${m.message ? `<span class="px-3 py-2 inline-block rounded-2xl break-words ${isMe ? "bg-blue-500 text-white right" : "bg-[#f3f3f3] text-black left"}"> ${m.message}</span>` : ""}
    
                    <p class="msg-time text-gray-500 text-xs mt-1" data-time="${m.created_at}">${Msago(m.created_at)}</p> 
                </div>`;
                box.appendChild(div);
            });

            box.scrollTop = box.scrollHeight;
        }

        async function updateUsers() {
            conversation = []

            let userlist = await fetch('/message/userlist')
            let res = await userlist.json()

            if (res.message.length > 0) {
                conversation = res.message
                usrList()
            } else {
                userList.innerHTML = `
                        <p class="text-center text-gray-500 mt-10">
                    No Messages ðŸ˜´
                </p>`
            }

            socket.on("online:list", ({ onlineUsers }) => {
                const myId = Number(current.value);

                conversation.forEach(user => {
                    user.isActive = onlineUsers.includes(String(user.Id)) && user.Id !== myId;
                });

                usrList();
            });

        }

        function renderOwnMessage(m) {
            let filesHTML = "";
            let cope = null

            if (Array.isArray(m.files)) {
                m.files.forEach(file => {
                    cope = file.url
                    if (file.type === "image") {
                        filesHTML += `<img src="${file.url}" class="mt-2 right max-w-[220px]" />`;
                    }
                    else if (file.type === "audio") {
                        filesHTML += `<audio controls class="mt-2 max-w-[220px]"><source src="${file.url}"></audio>`;
                    }
                    else {
                        filesHTML += `
                    <a href="${file.url}" target="_blank" class="block mt-2 text-white underline">ðŸ“„ ${file.name || "Download file"}</a>`;
                    }
                });
            }

            const div = document.createElement("div");
            div.className = "text-right";

            div.innerHTML = `
    <div class="group relative inline-block max-w-[70%]">

      ${filesHTML ? `${filesHTML}` : ""}

        <button onclick="unsendMessage(${m.Id})"class="w-full text-left px-4 py-2 text-red-500 hover:bg-gray-100">ðŸ—‘ Unsend </button>
        <button onclick="copyMessage('${m.message ? `${m.message}` : `${cope}`}')" class="w-full text-left px-4 py-2 hover:bg-gray-100"> ðŸ“‹ Copy</button>
        ${m.message ? `<span class="px-3 py-2 inline-block rounded-2xl break-words bg-blue-500 text-white right"> ${m.message}</span>` : ""}
        <div class="absolute -bottom-2 w-30 cursor-pointer ${isMe ? "-left-30" : "-right-30"} overflow-hidden rounded-xl flex flex-col bg-white shadow-md text-gray-500 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-all duration-150">
            <button onclick="unsendMessage(${m.Id})"class="w-full text-left px-4 py-2 text-red-500 hover:bg-gray-100">ðŸ—‘ Unsend </button>  
            <button onclick="copyMessage(this,'${m.message ? `${m.message}` : `${cope}`}')" class="w-full text-left px-4 py-2 hover:bg-gray-100">ðŸ“‹ Copy</button>
            <p class="msg-time text-gray-500 text-xs mt-1 text-center" data-time="${m.created_at}">${ago(m.created_at)}</p>
            <p class="msg-time text-gray-500 text-xs mt-1 text-center" data-time="${m.created_at}">${Msago(m.created_at)}</p>
        </div>
    
      <!-- Time -->
      <p class="msg-time text-gray-500 text-xs mt-1" data-time="${m.created_at}">${Msago(m.created_at)}</p>
 
    </div>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }


        window.addEventListener('load', async () => {
            socket = io({
                auth: { userId: current.value }
            });

            socket.on("connect", () => console.log("Connected:", socket.id));

            socket.on("recieveMessage", (data) => {
                appendIncomingMessage(data)
            });

            updateUsers()

        });


        setInterval(() => {
            document.querySelectorAll(".timeo").forEach(el => {
                const time = el.getAttribute("data-time");
                if (time) {
                    el.innerText = ago(time);
                }
            })
            document.querySelectorAll(".msg-time").forEach(el => {
                const time = el.getAttribute("data-time");
                if (time) {
                    el.innerText = Msago(time);
                }
            });
        }, 30000);

        keyss.forEach(keys => {
            keys.addEventListener('keydown', (e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

    </script>

</body>

</html>